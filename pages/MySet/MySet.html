<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title>阅美乐-我-设置</title>
		<link href="../../css/public.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.picker.min.css" />
		<link rel="stylesheet" type="text/css" href="../../js/mui.poppicker.css" />
		<link href="MySet.css" rel="stylesheet" />
	</head>
	<body>
		<!-- 返回按钮 -->
		<div class="mui-fanhui mui-action-back" id="Return">
			<img src="../../img/fanhui_01.png">
		</div>
		<div class="set-new-init">
			<h2 class="set-tit">设置</h2>
			<p class="set-text">个人信息修改</p>
			<div class="content">

				<div class="set-inits">
					<div class="set-content" id="set_name">
						<span>修改真实姓名</span><i></i>
					</div>
					<div class="set-content">
						<span id="mobile">手机号码</span><i></i>
					</div>
				</div>
				<div class="set-content" id="set_ChengShi">
					<span id="cs_box">城市</span><i></i>
				</div>
				<div class="set-inits">
					<div class="set-content" id="set_time">
						<span>健康使用时间设置</span><i></i>
					</div>
					<div class="set-content" id="set_HuanCun">
						<span>清除缓存</span><span class="set-foo"></span><i></i>
					</div>
				</div>
				<div class="set-inits">
					<div class="set-content" id="set_TuiSong">
						<span>清除下载的文件</span><i></i>
					</div>
					<div class="set-content" id="set_WenTi">
						<span>常见问题答疑</span><i></i>
					</div>
				</div>
			</div>
			<button type="button" class="set-but-dec" id="tuibut">退出登录</button>
		</div>
		<!-- 健康使用时间设置 -->
		<div class="time-out">
			<div class="time-set-list">
				<p class="time-set-title">护眼模式选择</p>
				<p class="time-set-text time-set-active">15分钟</p>
				<p class="time-set-text">30分钟</p>
				<p class="time-set-text">45分钟</p>
				<p class="time-set-text">不限制</p>
				<span id="time_dec"></span>
			</div>
		</div>
		<!-- 清除缓存 -->
		<div class="clear_cache" id="clear_cache">
			<div class="cache">
				<p>确定清除缓存吗?</p>
				<div class="cache-init">
					<button type="button" id="cache-ok">确&nbsp;&nbsp;定</button>
					<button type="button" id="cache-no">取&nbsp;&nbsp;消</button>
				</div>
			</div>
		</div>
		<!-- 清除下载的文件 -->
		<div class="clear_cache" id="clear_file">
			<div class="cache">
				<p style="padding:0px 0.625rem;font-size:1rem;">确定删除下载的资源?您下次浏览的时候需要流量重新下载哦!</p>
				<div class="cache-init">
					<button type="button" id="file-ok">确&nbsp;&nbsp;定</button>
					<button type="button" id="file-no">取&nbsp;&nbsp;消</button>
				</div>
			</div>
		</div>
		<!-- 修改昵称 -->
		<div class="modify-name modify-bar">
			<div class="modify">
				<p>修改昵称</p>
				<div class="modify-init">
					<input type="text" name="" id="modify-init-value" value="" placeholder="输入修改的昵称" />
					<span id="modify-delete"></span>
				</div>
				<div class="modify-but">
					<button type="button" id="modify-ok">确认修改</button>
					<button type="button" id="modify-no">取&nbsp;&nbsp;&nbsp;消</button>
				</div>
			</div>
		</div>
		<!-- 手机号码 -->
		<div class="modify-name mobile">
			<div class="modify">
				<p>手机号码</p>
				<div class="modify-init">
					<input type="" name="" id="mobile-value" value="" placeholder="输入手机号码" />
					<span id="mobile-delete"></span>
				</div>
				<div class="modify-but">
					<button type="button" id="mobile-ok">确&nbsp;&nbsp;&nbsp;认</button>
					<button type="button" id="mobile-no">取&nbsp;&nbsp;&nbsp;消</button>
				</div>
			</div>
		</div>
		<!-- 城市选项卡 -->
		<div class="modify-name city—init">
			<div class="city-ch">
				<p>修改城市</p>
				<table class="demoTable">
					<tbody>
						<tr>
							<td class="td-06">
								<div class="zcityGroup city_1">
									<input type="" name="" id="citybut" readonly="readonly" placeholder="请选择" />
									<span class="mui-icon mui-icon-xia"></span>
									<span class="mui-icon-s"></span>
								</div>
								<div class="zcityGroup city_2">
									<input type="" name="" id="citybut1" value="" readonly="readonly" placeholder="请选择" />
									<span class="mui-icon mui-icon-xia"></span>
									<span class="mui-icon-s"></span>
								</div>
								<div class="zcityGroup city_3">
									<input type="" name="" id="citybut2" value="" readonly="readonly" placeholder="请选择" />
									<span class="mui-icon mui-icon-xia"></span>
									<span class="mui-icon-s"></span>
								</div>
							</td>
						</tr>
					</tbody>
				</table>
				<div class="city-but">
					<button type="button" id="city-ok">确&nbsp;&nbsp;&nbsp;定</button>
					<button type="button" id="city-no">取&nbsp;&nbsp;&nbsp;消</button>
				</div>
			</div>
		</div>

		<script src="../../js/jquery-1.12.0.min.js"></script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/mui.picker.min.js"></script>
		<script src="../../js/mui.poppicker.js"></script>
		<script src="../../js/city.data.js"></script>
		<script src="../../js/city.data-3.js"></script>
		<script src="../../js/app.js"></script>
		<script type="text/javascript">
			(function() {
				mui.init({
					swipeBack: false
				});
				var w, ws;

				mui.plusReady(function() {
					var _this = this;
					var size_m = ''; //app缓存
					var time = ''; //护眼时间
					var time1 = ''; //护眼时间

					ws = plus.webview.currentWebview();
					ws.setStyle(YiRu.viewstyle());
					YiRu.UserLogin();
					// 请求地址的接口
					YiRu.getajax('usercenter/getstudentinfo', function(data) {
						var ids = ",";
						$("#cs_box").html(data.data.baseinfo.Province + ids + data.data.baseinfo.City + ids + data.data.baseinfo.Area);
						$(".city_1").find("input").val(data.data.baseinfo.Province); //省
						$(".city_2").find("input").val(data.data.baseinfo.City); //市
						$(".city_3").find("input").val(data.data.baseinfo.Area); //区

					}, {
						studentid: YiRu.getuserinfo().userId,
					}, null, 'get');
					$('#mobile').html(YiRu.getuserinfo().mobile); //用户手机号
					$('#modify-init-value').val(YiRu.getuserinfo().realName); //用户昵称
					//$('#nickName').html(YiRu.getuserinfo().realName) //用户城市
					//console.log(JSON.stringify(YiRu.getuserinfo()));
					// 获取app缓存
					plus.cache.calculate(function(size) {
						sizeCache = size;
						this.size_m = parseFloat(sizeCache / (1024 * 1024)).toFixed(2);
						$(".set-foo").html(this.size_m + "MB");
					});
					// 退出登录
					mui('body').on('tap', '#tuibut', function() {

						mui.confirm('确定退出登录？', '提示', ['确定', '取消'], function(e) {
							if (e.index == 0) {
								YiRu.logout();
								YiRu.openVW("/pages/UserLogin/Userlogin.html");
								setTimeout(function() {
									YiRu.closeAllwebview("/pages/UserLogin/Userlogin.html");
								}, 300);
							}
						});

					});
					// 跳转到我的推送
					mui('body').on('tap', '#set_TuiSong', function() {
						$("#clear_file").show();
						// mui.confirm('确定删除下载的资源?您下次浏览的时候需要流量重新下载哦!', '提示', ['确定', '取消'], function(e) {
						// 	if (e.index == 0) {
						// 		qingchuwenjian("_downloads");
						// 	}
						// });


						//YiRu.openVW("/pages/MyPush/MyPush.html");
					});
					// 健康使用时间设置
					$("#time_dec").on("tap", function() {
						_this.time = $('.time-set-active').text();
						if (_this.time == '不限制') {
							_this.time1 = 0;
							getyecare()
						} else {
							_this.time1 = _this.time.substring(0, 2);
							getyecare()
						}

						$(".time-out").hide();
						//请求护眼接口

					});
					getyecare = function() {
						YiRu.getajax('usercenter/updateeyecare', function(data) {
							plus.nativeUI.toast("设置成功");
						}, {
							studentid: YiRu.getuserinfo().userId,
							eyecare: _this.time1,
						}, w, 'get');
					};

					$("#set_time").on("tap", function() {
						$(".time-out").show();
					});
					$(".time-set-text").on("tap", function() {
						$(".time-set-text").removeClass("time-set-active");
						$(this).addClass("time-set-active");
					});
					// 清除缓存
					$("#set_HuanCun").on("tap", function() {
						$("#clear_cache").show();
					});

					$("#cache-ok").on("tap", function() {
						if (_this.size_m > 0) {
							var _user = YiRu.getuserinfo();
							_user.headIcon = _user.baseheadIcon;
							var _teacher = YiRu.getteacherinfo();
							var _token = localStorage.getItem('$yml_baidutoken') || "";
							var _uuid = localStorage.getItem('$uuid') || "";
							plus.cache.clear(function() {
								localStorage.setItem('$uuid', _uuid);
								if (!!_token) {
									localStorage.setItem('$yml_baidutoken', _token);
								}
								YiRu.setuserinfo(_user, function() {
									plus.nativeUI.toast("缓存清除完毕");
									$(".set-foo").html(0 + "MB");
								});
								YiRu.setteacherinfo(_teacher, function() {});
							});
						}

						$("#clear_cache").hide();

					});
					$("#cache-no").on("tap", function() {
						$("#clear_cache").hide();
					});
					$("#file-ok").on("tap", function() {
						qingchuwenjian("_doc");
						$("#clear_file").hide();

					});
					$("#file-no").on("tap", function() {
						$("#clear_file").hide();
					});
					// 修改真实姓名
					$("#set_name").on("tap", function() {
						//$('#modify-init-value').val(YiRu.getuserinfo().realName); //用户昵称
						$(".modify-bar").show();
					});
					$("#modify-ok").on("tap", function() {
						//console.log($("#modify-init-value").val());
						if ($("#modify-init-value").val() == '') {
							plus.nativeUI.toast("请输入修改昵称");
						} else {
							//localStorage.setItem('$truename', $('#modify-init-value').val());						

							YiRu.getajax('usercenter/updatetruename', function(data) {
								var newitem = YiRu.getuserinfo();
								newitem.realName = $('#modify-init-value').val();
								newitem.headIcon = newitem.baseheadIcon;
								YiRu.setuserinfo(newitem, function() {
									plus.nativeUI.toast("修改成功");
									mui.fire(plus.webview.getWebviewById(plus.runtime.appid), "updateheadimg");
									mui.fire(plus.webview.getWebviewById("/pages/My/My.html"), "updateheadimg");

									var shoppingview = plus.webview.getWebviewById("/pages/shopping/shopping.html");
									if (shoppingview) mui.fire(shoppingview, "updateheadimg");
									var SchoolRecordview = plus.webview.getWebviewById("pages/SchoolRecord/SchoolRecord.html");
									if (SchoolRecordview) mui.fire(SchoolRecordview, "updateheadimg");
								});
							}, {
								studentid: YiRu.getuserinfo().userId,
								truename: $("#modify-init-value").val(),
							}, w, 'get');
							$(".modify-bar").hide();
						}
					});
					$("#modify-no").on("tap", function() {
						$(".modify-bar").hide();
					});
					$("#modify-delete").on("tap", function() {
						$("#modify-init-value").val('');
					});

					// 手机号码
					$("#set_HaoMa").on("tap", function() {
						$(".mobile").show();
					});
					$("#mobile-ok").on("tap", function() {
						$(".mobile").hide();
					});
					$("#mobile-no").on("tap", function() {
						$(".mobile").hide();
					});
					$("#mobile-delete").on("tap", function() {
						$("#mobile-value").val('');
					});
					// 城市选项卡
					$("#set_ChengShi").on("tap", function() {
						$(".city—init").show();
					});
					$("#set_WenTi").on("tap", function() {
						YiRu.openVW("/pages/My/WenTi.html");
					});
					$("#city-ok").on("tap", function() {

						YiRu.getajax('usercenter/updatecity', function(data) {
							//console.log(JSON.stringify(data));
							var newitem = YiRu.getuserinfo();
							newitem.headIcon = newitem.baseheadIcon;
							//console.log(JSON.stringify(newitem));
							//newitem.realName = $('#modify-init-value').val();
							//newitem.province=$("#citybut").val();
							//newitem.city=$("#citybut1").val();
							//newitem.area=$("#citybut2").val();
							YiRu.setuserinfo(newitem, function() {
								plus.nativeUI.toast("修改成功");
								getyecare();
								var ids = ",";
								$("#cs_box").html($("#citybut").val() + ids + $("#citybut1").val() + ids + $("#citybut2").val());

							});
							//localStorage.setItem('$truename', $('#modify-init-value').val());
						}, {
							studentid: YiRu.getuserinfo().userId,
							province: $("#citybut").val(),
							city: $("#citybut1").val(),
							area: $("#citybut2").val(),
						}, w, 'get');
						$(".modify-bar").hide();

						$(".city—init").hide();
					});
					$("#city-no").on("tap", function() {
						$(".city—init").hide();
					});

					// 地区选择
					var city_picker = new mui.PopPicker({
						layer: 3
					});
					city_picker.setData(cityData3);
					$("#citybut,#citybut1,#citybut2").on("tap", function() {
						setTimeout(function() {
							city_picker.show(function(items) {
								if ((items[0] || {}).text == undefined) {
									(items[0] || {}).text = "";
								} else if ((items[1] || {}).text == undefined) {
									(items[1] || {}).text = "";
								} else if ((items[2] || {}).text == undefined) {
									(items[2] || {}).text = "";
								}
								$("#citybut").val(items[0].text); //省
								$("#citybut1").val(items[1].text); //市
								$("#citybut2").val(items[2].text); //区
							})
						}, 200);
					});

					// loadPage = function() {
					// 	w = plus.nativeUI.showWaiting('', YiRu.WaitingStyle());
					// 	/*
					//                      逻辑代码
					// 	*/
					//    w.close();
					// };

					function qingchuwenjian(dirPath) {
						w = plus.nativeUI.showWaiting('', YiRu.WaitingStyle());
						plus.io.resolveLocalFileSystemURL(dirPath, function(entry) {
							//读取这个目录对象    
							var directoryReader = entry.createReader();
							// console.log(dirPath)    
							//读取这个目录下的所有文件    
							directoryReader.readEntries(function(entries) {
								// console.log(entries.length)    
								//如果有才操作    
								if (entries.length > 0) {
									//删除目录将会删除其下的所有文件及子目录 不能删除根目录，如果操作删除根目录  
									//将会删除目录下的文件及子目录，不会删除根目录自身。 删除目录成功通过succesCB  
									//回调返回，失败则通过errorCB返回。  
									entry.removeRecursively(function(entry) {
										YiRu.getheadIconUrl(YiRu.getuserinfo().baseheadIcon, function(baseheadIcon) {
											w.close();
											mui.toast('清除成功(' + entries.length + ')');
										});
										//console.log('删除成功回调');
										//删除成功回调    
									}, function(e) {
										// console.log('!!')    
										//错误信息    
										w.close();
										mui.toast(e.message + ' ?!');
									});
								} else {
									mui.toast('清除成功');
									w.close();
								}
							}, function(e) {
								w.close();
								mui.toast('读取文件失败：' + e.message)
							})
						}, function(e) {
							w.close();
							mui.toast('读取目录失败：' + e.message)
						});
					}
				});
			})();
		</script>
	</body>
</html>
